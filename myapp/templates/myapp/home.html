{% extends "myapp/base.html" %}
{% load django_bootstrap5 %}
{% load static %} 

{% block content %}
<div class="container mt-4">

    <!-- üîπ ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ -->
    {% if google_maps_api_key %}
    <div class="mb-4">
        <h4>üìç ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ‡πÉ‡∏ô‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</h4>
        <div class="map-container">
            <iframe
                id="mapFrame"
                width="100%"
                height="450"
                style="border:0"
                loading="lazy"
                allowfullscreen
                referrerpolicy="no-referrer-when-downgrade"
                data-api-key="{{ google_maps_api_key }}"
                src="https://www.google.com/maps/embed/v1/place?key={{ google_maps_api_key }}&q=Phuket,Thailand">
            </iframe>
        </div>
    </div>
    {% else %}
    <p class="text-danger">‚ö†Ô∏è Google Maps API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
    {% endif %}
    
    <!-- üîπ Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
    <div class="mb-3">
        <label for="locationSelect" class="form-label">üîΩ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</label>
        <select id="locationSelect" class="form-select">
            <option value="" selected disabled>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</option>
            {% for location in locations %}
                <option value="{{ location.latitude }},{{ location.longitude }}">
                    {{ location.name }}
                </option>
            {% empty %}
                <option disabled>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- üîπ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
    <div class="row">
        {% for location in locations %}
        <div class="col-md-3 mb-2">
            <button class="btn btn-light w-100 map-button" data-location="{{ location.latitude }},{{ location.longitude }}">
                {{ location.name }}
            </button>
        </div>
        {% endfor %}
    </div>
      
    <!-- üîπ JavaScript ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let mapFrame = document.getElementById("mapFrame");
            let apiKey = mapFrame ? mapFrame.getAttribute("data-api-key") : null;

            if (!apiKey) {
                console.error("‚ùå API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö settings.GOOGLE_MAPS_API_KEY");
                return;
            }

            function updateMap(lat, lng) {
                if (lat && lng) {
                    mapFrame.src = `https://www.google.com/maps/embed/v1/place?key=${apiKey}&q=${lat},${lng}`;
                } else {
                    console.warn("‚ö†Ô∏è ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:", lat, lng);
                }
            }

            // üéØ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dropdown
            let selectBox = document.getElementById("locationSelect");
            if (selectBox) {
                selectBox.addEventListener("change", function () {
                    if (this.value) {
                        let [lat, lng] = this.value.split(",");
                        updateMap(lat, lng);
                    }
                });
            }

            // üéØ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ
            document.querySelectorAll(".map-button").forEach(button => {
                button.addEventListener("click", function () {
                    let [lat, lng] = this.dataset.location.split(",");
                    updateMap(lat, lng);
                });
            });
        });
    </script>
    

</div>
    <!-- üîπ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤ -->
    <form method="GET" action="{% url 'home' %}" class="row g-3">
        <div class="col-md-3">
            <label class="form-label">üìÖ ‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏ñ</label>
            <input type="datetime-local" class="form-control" name="pickup_date" value="{{ request.GET.pickup_date }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">üìÖ ‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</label>
            <input type="datetime-local" class="form-control" name="return_date" value="{{ request.GET.return_date }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-warning w-100">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πà‡∏≤</button>
        </div>
    </form>

    <!-- üîπ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å -->
    <div class="row mt-4">
        
        <!-- üîπ Sidebar ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
        <div class="col-md-3">
            <div class="filter-box p-3 bg-white shadow-sm rounded">
                <h5>‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5>
                <hr>

                <!-- üîπ ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ -->
                <form method="GET" action="{% url 'home' %}">
                    <label class="form-label">üöó ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏£‡∏ñ</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for brand in brands %}
                        <button type="submit" name="brand" value="{{ brand }}" class="btn btn-light border w-100 p-2">
                            <img src="{% static 'images/brands/'|add:brand|lower|add:'.png' %}" alt="{{ brand }}" class="img-fluid" style="max-height: 40px;">
                            <p class="mt-1 small">{{ brand }}</p>
                        </button>
                        {% endfor %}
                    </div>
                </form>
                
                <hr>
                
                <!-- üîπ ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                <form method="GET" action="{% url 'home' %}">
                    <label class="form-label">üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="min_price" value="{{ request.GET.min_price|default:1 }}" min="1" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                        <span class="input-group-text">‡∏ñ‡∏∂‡∏á</span>
                        <input type="number" class="form-control" name="max_price" value="{{ request.GET.max_price|default:6000 }}" min="1" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                    </div>
                    <button type="submit" class="btn btn-secondary mt-2 w-100">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                </form>
                
                <hr>

                <!-- üîπ ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á -->
                <form method="GET" action="{% url 'home' %}">
                    <label class="form-label">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</label>
                    <select class="form-select" name="seats" onchange="this.form.submit()">
                        <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                        {% for seat in seat_options %}
                            <option value="{{ seat }}" {% if request.GET.seats == seat|stringformat:"s" %}selected{% endif %}>{{ seat }} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        <!-- üîπ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ñ -->
        <div class="col-md-9">
            <h4>üöó ‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <div class="row">
                {% for car in cars %}
                <div class="col-md-6 mb-4">
                    <div class="card car-card shadow-sm">
                        <img src="{% if car.image %}{{ car.image.url }}{% else %}{% static 'images/default-car.png' %}{% endif %}" class="card-img-top" alt="{{ car.name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ car.name }}</h5>
                            <p class="card-text">{{ car.brand }} - {{ car.model }} ({{ car.year }})</p>
                            <p class="text-muted">üë• {{ car.seats }} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</p>
                            <p class="text-success">üí∞ ‡∏ø{{ car.price_per_day }}/‡∏ß‡∏±‡∏ô</p>
                            {% if request.GET.pickup_date and request.GET.return_date %}
                                <p class="text-danger">üî• ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ‡∏ø{{ car.total_price }}</p>
                            {% endif %}
                            <a href="{% url 'car_detail' car.id %}?pickup_date={{ request.GET.pickup_date }}&return_date={{ request.GET.return_date }}"
                            class="btn btn-primary">
                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </a>


                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}